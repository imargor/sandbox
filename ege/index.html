<!DOCTYPE HTML>
<!-- 2018-04-09 mgo -->
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>EGE Demo - Web Bluetooth</title>
    <meta name="description" content="Monitor flow, flow and output state from a EGE sensor with a Web Bluetooth app">
    <!-- TODO: manfifest -->
    <!-- TODO: favicon -->

    <!-- JavaScript -->
    <script>
        const sensorServiceUUID = '389701f6-2b73-11e8-b467-0ed5f89f718b';
        const flowCharacteristicUUID = '389701f7-2b73-11e8-b467-0ed5f89f718b';
        const temperatureCharacteristicUUID = '389701f8-2b73-11e8-b467-0ed5f89f718b';
        const outputStateCharacteristicUUID = '389701f9-2b73-11e8-b467-0ed5f89f718b';

        var bleDevice;
        var bleServer;

        var sensorService;
        var flowChar;
        var temperatureChar;
        var outputStateChar;


        window.onload = function () {
            document.querySelector('#connect').addEventListener('click', connect);
            document.querySelector('#disconnect').addEventListener('click', disconnect);

        };

        function connect() {
            if (!navigator.bluetooth) {
                return log('Web Bluetooth API is not available in browser.');
            }
            log('=============================');
            log('Requesting Bluetooth Device...');

            navigator.bluetooth.requestDevice({
                    //filters: [{
                        //services: [sensorServiceUUID],
                        //"name": "SDNC"
                    //}]
                })
                .then(device => {
                    bleDevice = device;
                    console.log({
                        Name: device.name,
                        Id: device.id,
                        UUIDs: device.uuids,
                        Device: device
                    });
                    log('Connected to device: ' + device.name);
                    return device.gatt.connect();
                })
                .then(server => {
                    bleServer = server;
                    log('Found Server', server);
                })
                .then(() => bleServer.getPrimaryService(sensorServiceUUID))
                .then(service => {
                    log('Found sensor service', service);
                    sensorService = service;
                })
                .then(() => sensorService.getCharacteristic(flowCharacteristicUUID))
                .then(characteristic => {
                    log('Found flow characteristic');
                    flowChar = characteristic;
                    return flowChar.startNotifications();
                })
                .then(() => {
                    log('Notifications for flow enabled');
                    return flowChar.addEventListener('characteristicvaluechanged', handleNotifyFlow);
                })
                .then(() => sensorService.getCharacteristic(temperatureCharacteristicUUID))
                .then(characteristic => {
                    log('Found temeperature characteristic');
                    temperatureChar = characteristic;
                    return temperatureChar.startNotifications();
                })
                .then(() => {
                    log('Notifications for temperature enabled');
                    return temperatureChar.addEventListener('characteristicvaluechanged', handleNotifyTemperature);
                })
                .then(() => sensorService.getCharacteristic(outputStateCharacteristicUUID))
                .then(characteristic => {
                    log('Found output state characteristic');
                    outputStateChar.startNotifications();
                })
                .then(() => {
                    log('Notifications for output state enabled');
                    return outputStateChar.addEventListener('characteristicvaluechanged', handleNotifyOutputState);
                })
                .then(() => {
                    log('=========== READY ===========');
                })
                .catch(error => {
                    log('Connection Error: ' + error);
                });
        }


        function disconnect() {
            if (!bleDevice) {
                log('No Bluetooth Device found...');
                return;
            }
            log('Disconnecting from Bluetooth Device...');
            if (bleDevice.gatt.connected) {
                bleDevice.gatt.disconnect();
                log('Bluetooth Device connected: ' + bleDevice.gatt.connected);
            } else {
                log('Bluetooth Device is already disconnected');
            }
        }

        function handleNotifyFlow(event) {
            const flowValue = event.target.value;
            console.log("flowValue", flowValue.length, flowValue.getUint8())

            const integer = flowValue.getInt8(0);
            const decimal = flowValue.getUint8(1);
            const flow = integer + ',' + decimal;
            log('flow event: ' + flow, integer, decimal);
        }

        function handleNotifyTemperature(event) {
            const temperatureValue = event.target.value;
            const integer = temperatureValue.getInt32(0, true);
            const decimal = temperatureValue.getUint8(4);
            const temperature = integer + ',' + decimal;
            log('temperature event: ' + temperature, integer, decimal)
        }

        function handleNotifyOutputState(event) {
            const OutputStateValue = event.target.value;
            const outputState = OutputStateValue.getUint8(0);
            log('outputState event: ' + outputState + 'False/True')
        }


        function log(text) {
            console.log(arguments);
            const logElm = document.querySelector('#log');
            logElm.textContent = text + '\n' + logElm.textContent;
        }
    </script>
</head>

<body>
    <button id="connect">Connect</button>
    <button id="disconnect">Disonnect</button>
    <div>
        <pre id="log"></pre>
    </div>
</body>

</html>